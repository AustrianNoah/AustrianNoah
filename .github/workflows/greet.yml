name: Follower Begr√º√üung

on:
  schedule:
    # L√§uft jeden Tag um 12:00 UTC (14:00 MESZ)
    - cron: '0 12 * * *'
  workflow_dispatch: # Erm√∂glicht manuellen Start

jobs:
  greet-new-followers:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Begr√º√üe neue Follower
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO_OWNER: ${{ github.repository_owner }}
      run: |
        # Erstelle Verzeichnis f√ºr Daten falls nicht vorhanden
        mkdir -p .github/data
        
        # Datei f√ºr bekannte Follower
        KNOWN_FOLLOWERS_FILE=".github/data/known_followers.txt"
        
        # Aktuelle Follower abrufen
        echo "üîç Aktuelle Follower werden abgerufen..."
        gh api users/$REPO_OWNER/followers --paginate --jq '.[].login' > current_followers.txt
        
        # Wenn keine bekannten Follower vorhanden, initialisiere Liste
        if [ ! -f "$KNOWN_FOLLOWERS_FILE" ]; then
          echo "üìù Initialisiere Follower-Liste..."
          cp current_followers.txt "$KNOWN_FOLLOWERS_FILE"
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add "$KNOWN_FOLLOWERS_FILE"
          git commit -m "Initialisiere Follower-Liste" || true
          git push || true
          echo "‚úÖ Follower-Liste initialisiert. Beim n√§chsten Lauf werden neue Follower begr√º√üt."
          exit 0
        fi
        
        # Neue Follower identifizieren
        echo "üÜï Suche nach neuen Followern..."
        NEW_FOLLOWERS=$(comm -13 <(sort "$KNOWN_FOLLOWERS_FILE") <(sort current_followers.txt))
        
        if [ -z "$NEW_FOLLOWERS" ]; then
          echo "üòä Keine neuen Follower gefunden."
        else
          echo "üéâ Neue Follower gefunden:"
          echo "$NEW_FOLLOWERS"
          
          # F√ºr jeden neuen Follower
          while IFS= read -r follower; do
            if [ ! -z "$follower" ]; then
              echo "üëã Begr√º√üe $follower..."
              
              # Follower-Informationen abrufen
              USER_INFO=$(gh api users/$follower)
              USER_NAME=$(echo "$USER_INFO" | jq -r '.name // .login')
              USER_BIO=$(echo "$USER_INFO" | jq -r '.bio // "Kein Bio verf√ºgbar"')
              USER_LOCATION=$(echo "$USER_INFO" | jq -r '.location // "Unbekannt"')
              USER_COMPANY=$(echo "$USER_INFO" | jq -r '.company // "Keine Firma angegeben"')
              
              # Issue erstellen zur Begr√º√üung
              ISSUE_BODY="Hallo @$follower! üëã

Herzlich willkommen! Vielen Dank, dass du mir folgst! üéâ

**Deine Informationen:**
- üë§ Name: $USER_NAME
- üìç Standort: $USER_LOCATION
- üè¢ Firma: $USER_COMPANY
- üìù Bio: $USER_BIO

Ich freue mich √ºber dein Interesse an meinen Projekten! Wenn du Fragen hast oder bei einem Projekt mithelfen m√∂chtest, z√∂gere nicht, mich zu kontaktieren.

Happy Coding! üöÄ

---
*Diese Nachricht wurde automatisch generiert durch GitHub Actions.*"

              # Issue erstellen
              gh issue create \
                --title "Willkommen @$follower! üéâ" \
                --body "$ISSUE_BODY" \
                --label "welcome,follower" || echo "‚ùå Fehler beim Erstellen des Issues f√ºr $follower"
              
              # Kurze Pause zwischen den Anfragen
              sleep 2
            fi
          done <<< "$NEW_FOLLOWERS"
          
          # Follower-Liste aktualisieren
          cp current_followers.txt "$KNOWN_FOLLOWERS_FILE"
          
          # √Ñnderungen committen
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add "$KNOWN_FOLLOWERS_FILE"
          git commit -m "Aktualisiere Follower-Liste - $(echo "$NEW_FOLLOWERS" | wc -l) neue Follower begr√º√üt" || true
          git push || true
        fi
        
        # Aufr√§umen
        rm -f current_followers.txt
        
        echo "‚úÖ Workflow abgeschlossen!"

    - name: GitHub CLI installieren (falls nicht vorhanden)
      run: |
        if ! command -v gh &> /dev/null; then
          echo "GitHub CLI wird installiert..."
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh
        fi